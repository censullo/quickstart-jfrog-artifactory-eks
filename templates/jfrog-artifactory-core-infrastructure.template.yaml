AWSTemplateFormatVersion: '2010-09-09'
Description: 'JFrog Artifactory Quick Start Deployment (qs-1qpmmjh61)'
Metadata:
  cfn-lint:
    config:
      ignore_checks:
        - W9002
        - W9003
        - W9004
        - W9006
Parameters:
  VpcId:
    Type: AWS::EC2::VPC::Id
  VpcCidr:
    Description: CIDR block for the VPC
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.0.0/16
    Type: String
  PrivateSubnet1Cidr:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.0.0/19
    Type: String
  PrivateSubnet2Cidr:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.32.0/19
    Type: String
  PrivateSubnet3Cidr:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.64.0/19
    Type: String
  SubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
  DatabaseAllocatedStorage:
    Type: Number
  MultiAzDatabase:
    Type: String
  DatabaseEngine:
    Type: String
  DatabaseUser:
    Type: String
  DatabasePassword:
    NoEcho: 'true'
    Type: String
  DatabaseInstance:
    Type: String
  DatabaseName:
    Type: String
  ArtifactoryProduct:
    Default: JFrog-Artifactory-Pro
    Type: String
  ReleaseStage:
    Default: GA
    Type: String
  InstanceType:
    Default: m4.xlarge
    Type: String

Mappings:
  DatabaseMap:
    Postgres:
      Name: postgresql
      DatabaseVersion: 11.5
      Driver: "org.postgresql.Driver"
      Plugin: postgresql-42.2.9.jar
      PluginURL: https://jdbc.postgresql.org/download/
      port: "5432"
      extraDatabaseOps: ""
    MySQL:
      Name: mysql
      DatabaseVersion: 5.7
      Driver: "com.mysql.jdbc.Driver"
      Plugin: mysql-connector-java-8.0.19.jar
      PluginURL: https://bintray.com/artifact/download/bintray/jcenter/mysql/mysql-connector-java/8.0.19/
      port: "3306"
      extraDatabaseOps: "?characterEncoding=UTF-8&elideSetAutoCommits=true"
  ReleaseStageMap:
    BETA:
      ProDockerRepo: "earlyaccess-docker.jfrog.io/jfrog/artifactory-pro"
      JcrDockerRepo: "earlyaccess-docker.jfrog.io/jfrog/artifactory-jcr"
      NginxDockerRepo: "earlyaccess-docker.jfrog.io/jfrog/nginx-artifactory-pro"
    GA:
      ProDockerRepo: "docker.bintray.io/jfrog/artifactory-pro"
      JcrDockerRepo: "docker.bintray.io/jfrog/artifactory-jcr"
      NginxDockerRepo: "docker.bintray.io/jfrog/nginx-artifactory-pro"
  ProductMap:
    JFrog-Container-Registry:
      RepoName: JcrDockerRepo
    JFrog-Artifactory-Pro:
      RepoName: ProDockerRepo
  JavaOptionstoInstance:
    m4.large:
      Min: 4
      Max: 4
      DeploymentSize: xxSmall
    m4.xlarge:
      Min: 8
      Max: 12
      DeploymentSize: xSmall
    m4.2xlarge:
      Min: 16
      Max: 24
      DeploymentSize: Small
    m4.4xlarge:
      Min: 32
      Max: 48
      DeploymentSize: Medium
    m4.10xlarge:
      Min: 80
      Max: 120
      DeploymentSize: Large
    m4.16xlarge:
      Min: 128
      Max: 192
      DeploymentSize: xxLarge
    m5.large:
      Min: 4
      Max: 4
      DeploymentSize: xxSmall
    m5.xlarge:
      Min: 8
      Max: 12
      DeploymentSize: xSmall
    m5.2xlarge:
      Min: 16
      Max: 24
      DeploymentSize: Small
    m5.4xlarge:
      Min: 32
      Max: 48
      DeploymentSize: Medium
    m5.8xlarge:
      Min: 64
      Max: 96
      DeploymentSize: Large
    m5.12xlarge:
      Min: 96
      Max: 144
      DeploymentSize: xLarge
    m5.16xlarge:
      Min: 128
      Max: 192
      DeploymentSize: xxLarge
    m5.24xlarge:
      Min: 192
      Max: 288
      DeploymentSize: xxxLarge
    m5.metal:
      Min: 192
      Max: 288
      DeploymentSize: xxxLarge
    m5d.large:
      Min: 4
      Max: 4
      DeploymentSize: xxSmall
    m5d.xlarge:
      Min: 8
      Max: 12
      DeploymentSize: xSmall
    m5d.2xlarge:
      Min: 16
      Max: 24
      DeploymentSize: Small
    m5d.4xlarge:
      Min: 32
      Max: 48
      DeploymentSize: Medium
    m5d.8xlarge:
      Min: 64
      Max: 96
      DeploymentSize: Large
    m5d.12xlarge:
      Min: 96
      Max: 144
      DeploymentSize: xLarge
    m5d.16xlarge:
      Min: 128
      Max: 192
      DeploymentSize: xxLarge
    m5d.24xlarge:
      Min: 192
      Max: 288
      DeploymentSize: xxxLarge
    m5d.metal:
      Min: 192
      Max: 288
      DeploymentSize: xxxLarge
    m5a.large:
      Min: 4
      Max: 4
      DeploymentSize: xxSmall
    m5a.xlarge:
      Min: 8
      Max: 12
      DeploymentSize: xSmall
    m5a.2xlarge:
      Min: 16
      Max: 24
      DeploymentSize: Small
    m5a.4xlarge:
      Min: 32
      Max: 48
      DeploymentSize: Medium
    m5a.8xlarge:
      Min: 64
      Max: 96
      DeploymentSize: Large
    m5a.12xlarge:
      Min: 96
      Max: 144
      DeploymentSize: xLarge
    m5a.16xlarge:
      Min: 128
      Max: 192
      DeploymentSize: xxLarge
    m5a.24xlarge:
      Min: 192
      Max: 288
      DeploymentSize: xxxLarge
    m5ad.large:
      Min: 4
      Max: 4
      DeploymentSize: xxSmall
    m5ad.xlarge:
      Min: 8
      Max: 12
      DeploymentSize: xSmall
    m5ad.2xlarge:
      Min: 16
      Max: 24
      DeploymentSize: Small
    m5ad.4xlarge:
      Min: 32
      Max: 48
      DeploymentSize: Medium
    m5ad.12xlarge:
      Min: 96
      Max: 144
      DeploymentSize: xLarge
    m5ad.24xlarge:
      Min: 192
      Max: 288
      DeploymentSize: xxxLarge
Resources:
  ArtifactoryDatabaseSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Private Subnets available to the RDS Instance(s)
      SubnetIds: !Ref SubnetIds
  ArtifactoryDatabase:
    Type: AWS::RDS::DBInstance
    Properties:
      AllocatedStorage: !Ref DatabaseAllocatedStorage
      MultiAZ: !Ref MultiAzDatabase
      Engine: !Ref DatabaseEngine
      EngineVersion: !FindInMap
        - DatabaseMap
        - !Ref DatabaseEngine
        - DatabaseVersion
      MasterUsername: !Ref DatabaseUser
      MasterUserPassword: !Ref DatabasePassword
      DBInstanceClass: !Ref DatabaseInstance
      DBName: !Ref DatabaseName
      DBSubnetGroupName: !Ref  ArtifactoryDatabaseSubnetGroup
      VPCSecurityGroups:
        - !Ref ArtifactoryDatabaseSG
  ArtifactoryDatabaseSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      Tags:
        - Key: Name
          Value: artifactory-rds-sg
      GroupDescription: SG for RDS Instance to allow communication from the Bastion and Artifactory servers.
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref VpcCidr
        - IpProtocol: tcp
          FromPort: !FindInMap
            - DatabaseMap
            - !Ref DatabaseEngine
            - port
          ToPort: !FindInMap
            - DatabaseMap
            - !Ref DatabaseEngine
            - port
          CidrIp: !Ref PrivateSubnet1Cidr
        - IpProtocol: tcp
          FromPort: !FindInMap
            - DatabaseMap
            - !Ref DatabaseEngine
            - port
          ToPort: !FindInMap
            - DatabaseMap
            - !Ref DatabaseEngine
            - port
          CidrIp: !Ref PrivateSubnet2Cidr
        - IpProtocol: tcp
          FromPort: !FindInMap
            - DatabaseMap
            - !Ref DatabaseEngine
            - port
          ToPort: !FindInMap
            - DatabaseMap
            - !Ref DatabaseEngine
            - port
          CidrIp: !Ref PrivateSubnet3Cidr
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
  ArtifactoryS3IAMUser:
    Type: AWS::IAM::User
  ArtifactoryIamAcessKey:
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: !Ref ArtifactoryS3IAMUser
  ArtifactoryS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: Private
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
  ArtifactoryS3IAMPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: S3BucketPermissions
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: S3BucketPermissions
            Effect: Allow
            Action:
              - s3:AbortMultipartUpload
              - s3:BypassGovernanceRetention
              - s3:CreateAccessPoint
              - s3:CreateAccessPointForObjectLambda
              - s3:CreateBucket
              - s3:CreateJob
              - s3:DeleteAccessPoint
              - s3:DeleteAccessPointForObjectLambda
              - s3:DeleteAccessPointPolicy
              - s3:DeleteAccessPointPolicyForObjectLambda
              - s3:DeleteBucket
              - s3:DeleteBucketOwnershipControls
              - s3:DeleteBucketPolicy
              - s3:DeleteBucketWebsite
              - s3:DeleteJobTagging
              - s3:DeleteObject
              - s3:DeleteObjectTagging
              - s3:DeleteObjectVersion
              - s3:DeleteObjectVersionTagging
              - s3:DeleteStorageLensConfiguration
              - s3:DeleteStorageLensConfigurationTagging
              - s3:DescribeJob
              - s3:GetAccelerateConfiguration
              - s3:GetAccessPoint
              - s3:GetAccessPointConfigurationForObjectLambda
              - s3:GetAccessPointForObjectLambda
              - s3:GetAccessPointPolicy
              - s3:GetAccessPointPolicyForObjectLambda
              - s3:GetAccessPointPolicyStatus
              - s3:GetAccessPointPolicyStatusForObjectLambda
              - s3:GetAccountPublicAccessBlock
              - s3:GetAnalyticsConfiguration
              - s3:GetBucketAcl
              - s3:GetBucketCORS
              - s3:GetBucketLocation
              - s3:GetBucketLogging
              - s3:GetBucketNotification
              - s3:GetBucketObjectLockConfiguration
              - s3:GetBucketOwnershipControls
              - s3:GetBucketPolicy
              - s3:GetBucketPolicyStatus
              - s3:GetBucketPublicAccessBlock
              - s3:GetBucketRequestPayment
              - s3:GetBucketTagging
              - s3:GetBucketVersioning
              - s3:GetBucketWebsite
              - s3:GetEncryptionConfiguration
              - s3:GetIntelligentTieringConfiguration
              - s3:GetInventoryConfiguration
              - s3:GetJobTagging
              - s3:GetLifecycleConfiguration
              - s3:GetMetricsConfiguration
              - s3:GetObject
              - s3:GetObjectAcl
              - s3:GetObjectLegalHold
              - s3:GetObjectRetention
              - s3:GetObjectTagging
              - s3:GetObjectTorrent
              - s3:GetObjectVersion
              - s3:GetObjectVersionAcl
              - s3:GetObjectVersionForReplication
              - s3:GetObjectVersionTagging
              - s3:GetObjectVersionTorrent
              - s3:GetReplicationConfiguration
              - s3:GetStorageLensConfiguration
              - s3:GetStorageLensConfigurationTagging
              - s3:GetStorageLensDashboard
              - s3:ListAccessPoints
              - s3:ListAccessPointsForObjectLambda
              - s3:ListAllMyBuckets
              - s3:ListBucket
              - s3:ListBucketMultipartUploads
              - s3:ListBucketVersions
              - s3:ListJobs
              - s3:ListMultipartUploadParts
              - s3:ListStorageLensConfigurations
              - s3:ObjectOwnerOverrideToBucketOwner
              - s3:PutAccelerateConfiguration
              - s3:PutAccessPointConfigurationForObjectLambda
              - s3:PutAccessPointPolicy
              - s3:PutAccessPointPolicyForObjectLambda
              - s3:PutAccountPublicAccessBlock
              - s3:PutAnalyticsConfiguration
              - s3:PutBucketAcl
              - s3:PutBucketCORS
              - s3:PutBucketLogging
              - s3:PutBucketNotification
              - s3:PutBucketObjectLockConfiguration
              - s3:PutBucketOwnershipControls
              - s3:PutBucketPolicy
              - s3:PutBucketPublicAccessBlock
              - s3:PutBucketRequestPayment
              - s3:PutBucketTagging
              - s3:PutBucketVersioning
              - s3:PutBucketWebsite
              - s3:PutEncryptionConfiguration
              - s3:PutIntelligentTieringConfiguration
              - s3:PutInventoryConfiguration
              - s3:PutJobTagging
              - s3:PutLifecycleConfiguration
              - s3:PutMetricsConfiguration
              - s3:PutObject
              - s3:PutObjectAcl
              - s3:PutObjectLegalHold
              - s3:PutObjectRetention
              - s3:PutObjectTagging
              - s3:PutObjectVersionAcl
              - s3:PutObjectVersionTagging
              - s3:PutReplicationConfiguration
              - s3:PutStorageLensConfiguration
              - s3:PutStorageLensConfigurationTagging
              - s3:ReplicateDelete
              - s3:ReplicateObject
              - s3:ReplicateTags
              - s3:RestoreObject
              - s3:UpdateJobPriority
              - s3:UpdateJobStatus
            Resource:
              - Fn::Join:
                - ''
                - - "arn:aws:s3:::"
                  - !Ref ArtifactoryS3Bucket
              - Fn::Join:
                - ''
                - - "arn:aws:s3:::"
                  - !Ref ArtifactoryS3Bucket
                  - "/*"
      Users:
        - !Ref ArtifactoryS3IAMUser
Outputs:
  ArtifactoryIamAcessKey:
    Value: !Ref ArtifactoryIamAcessKey
    Description: IAM Access key for the S3 Bucket
  SecretAccessKey:
    Value: !GetAtt ArtifactoryIamAcessKey.SecretAccessKey
    Description: Secret Access key for S3 Bucket
  S3Bucket:
    Value: !Ref ArtifactoryS3Bucket
    Description: Actual S3 bucket created for Artifactory
  DatabaseDriver:
    Value: !FindInMap [DatabaseMap, !Ref DatabaseEngine, Driver]
  DatabasePlugin:
    Value: !FindInMap [DatabaseMap, !Ref DatabaseEngine, Plugin]
  DatabasePluginUrl:
    Value: !Sub
      - "${MainURL}${PluginVersion}"
      - {
        MainURL: !FindInMap [DatabaseMap, !Ref DatabaseEngine, PluginURL],
        PluginVersion: !FindInMap [DatabaseMap, !Ref DatabaseEngine, Plugin]
        }
  DatabaseType:
    Value: !FindInMap [DatabaseMap, !Ref DatabaseEngine, Name]
  DatabaseUrl:
    Value: !Sub
      - "jdbc:${DatabaseType}://${ArtifactoryDatabaseEndpointAddress}:${port}/${DatabaseName}${extraDatabaseOps}"
      - {
        DatabaseType: !FindInMap [DatabaseMap, !Ref DatabaseEngine, Name],
        ArtifactoryDatabaseEndpointAddress: !GetAtt ArtifactoryDatabase.Endpoint.Address,
        port: !FindInMap [DatabaseMap, !Ref DatabaseEngine, port],
        extraDatabaseOps: !FindInMap [DatabaseMap, !Ref DatabaseEngine, extraDatabaseOps],
        }
  ProDockerRepo:
    Value: !FindInMap
      - ReleaseStageMap
      - !Ref ReleaseStage
      - !FindInMap
        - ProductMap
        - !Ref ArtifactoryProduct
        - RepoName
  NginxDockerRepo:
    Value: !FindInMap [ReleaseStageMap, !Ref ReleaseStage, NginxDockerRepo]
  JavaOpts:
    Value: !Sub
      - "-Xms${min}g -Xmx${max}g"
      - {
        min: !FindInMap [JavaOptionstoInstance, !Ref InstanceType, Min],
        max: !FindInMap [JavaOptionstoInstance, !Ref InstanceType, Max]
      }
  DeploymentSize:
    Value: !FindInMap [JavaOptionstoInstance, !Ref InstanceType, DeploymentSize]
